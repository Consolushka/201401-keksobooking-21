(()=>{"use strict";(()=>{let e,t;const o=document.querySelector("#card").content.querySelector(".map__card"),r=document.querySelector("#card").content.querySelector(".popup__photo");window.cardModule={mainCard:document.querySelector(".map__card"),fill(o){this.create();let n=window.dataModule.ads[o];this.mainCard.querySelector(".popup__photos").innerHTML="",this.mainCard.removeAttribute("style"),this.mainCard.querySelector(".popup__title").textContent=n.offer.title,this.mainCard.querySelector(".popup__text--address").textContent=n.offer.address,this.mainCard.querySelector(".popup__text--price").textContent=n.offer.price+" ₽/ночь",this.mainCard.querySelector(".popup__type").textContent=""+window.dataModule.RoomTypeTranslator[n.offer.type],this.mainCard.querySelector(".popup__text--capacity").textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,this.mainCard.querySelector(".popup__text--time").textContent=`Заезд после ${n.offer.checkin}, выезд\t до ${n.offer.checkout}`,this.mainCard.querySelector(".popup__description ").textContent=n.offer.description,this.mainCard.querySelector(".popup__description ").textContent=n.offer.description,this.mainCard.querySelector(".popup__avatar").src=n.author.avatar,this.refactorLists(this.mainCard),Object.keys(n.offer).forEach((function(e){if(!n.offer[e])switch(e){case"rooms":case"guests":window.cardModule.mainCard.querySelector(".popup__text--capacity").setAttribute("style","display: none");break;default:window.cardModule.mainCard.querySelector(".popup__"+e).setAttribute("style","display: none"),window.cardModule.mainCard.querySelector(".popup__text--"+e).setAttribute("style","display: none")}})),this.fillList(e,"features",n,null),this.fillList(t,"photos",n,r)},refactorLists(o){e=o.querySelector(".popup__features"),e.innerHTML="",t=o.querySelector(".popup__photos"),null!==t.querySelector(".popup__photo")&&t.removeChild(t.querySelector(".popup__photo"))},fillList(e,t,o,r){for(let n=0;n<o.offer[t].length;n++){let d;"features"===t?(d=document.createElement("li"),d.className="popup__feature popup__feature--"+o.offer[t][n]):(d=r.cloneNode(!0),d.src=o.offer[t][n]),e.appendChild(d)}},hide(){document.querySelector(".map").querySelector(".map__card")&&document.querySelector(".map").removeChild(document.querySelector(".map__card"))},create(){let e=o.cloneNode(!0);document.querySelector(".map__filters-container").insertAdjacentHTML("beforebegin",e.outerHTML),this.mainCard=document.querySelector(".map__card"),this.mainCard.setAttribute("style","display: none")},closeEsc(e){"Escape"===e.key&&window.cardModule.mainCard.setAttribute("style","display: none")},closeClick(){window.cardModule.mainCard.setAttribute("style","display: none")}}})(),(()=>{const e=document.querySelector(".popup--error");window.dataModule={ads:[],ROOM_TYPE:["palace","flat","house","bungalow"],RoomTypeTranslator:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},FEATURES_LIST:["wifi","dishwasher","parking","washer","elevator","conditioner"],PHOTOS_LIST:["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],fillOffers(){window.loadModule(window.dataModule.loading,window.dataModule.error)},loading(e){for(let t=0;t<=e.length-1;t++)window.dataModule.ads.push(e[t]);window.dataModule.ads.forEach((function(e){e.matched=0,e.matches={features:[]}})),window.pinModule.load(5)},error(t){e.querySelector(".popup__text").textContent=t,e.classList.remove("popup--hidden"),e.querySelector(".popup__close").addEventListener("click",(function(){e.classList.remove("popup--hidden")}))}}})(),window.debounceModule=function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#capacity"),o=e.querySelector("#room_number"),r=e.querySelector("#type"),n=e.querySelector("#price"),d=e.querySelector("#timein"),i=e.querySelector("#timeout");window.formModule={checkingChanges(a){let u=e.querySelector("#capacity").value,c=e.querySelector("#room_number").value;switch(a.target.id){case"room_number":t.querySelectorAll("option").forEach((function(e){e.removeAttribute("selected"),e.setAttribute("disabled",""),e.value<=o.value&&"0"!==e.value?e.removeAttribute("disabled"):"0"===e.value&&"100"===o.value&&(e.setAttribute("selected",""),e.removeAttribute("disabled"))}));break;case"capacity":u===c&&t.setCustomValidity("");break;case"type":switch(r.value){case"bungalow":n.setAttribute("min","0"),n.setAttribute("placeholder","0");break;case"flat":n.setAttribute("min","1000"),n.setAttribute("placeholder","1000");break;case"house":n.setAttribute("min","5000"),n.setAttribute("placeholder","5000");break;case"palace":n.setAttribute("min","10000"),n.setAttribute("placeholder","10000")}break;case"timein":i.value=d.value;break;case"timeout":d.value=i.value;break;case"images":window.filesModule.adPhoto(a.target);break;case"avatar":window.filesModule.adAvatar(a.target)}},checkCapacity(){e.querySelector("#capacity").value!==e.querySelector("#room_number").value&&t.setCustomValidity("Значения должны быть идентичны")},submit(t){let o={features:[],photos:[],avatar:"asdasd"};o.title=e.querySelector("#title").value,o.checkin=e.querySelector("#timein").value,o.checkin=e.querySelector("#timeout").value,o.description=e.querySelector("#description").value,o.rooms=e.querySelector("#room_number").value,o.guests=e.querySelector("#capacity").value,o.address=e.querySelector("#address").value.toString(),o.price=e.querySelector("#price").value,o.type=e.querySelector("#type").value,e.querySelector(".features").querySelectorAll("input").forEach((function(e){e.checked&&o.offer.features.push(e.value)})),window.upload.send(new FormData(t.target),window.upload.createSuccess,window.upload.createError),t.preventDefault()},clear(){e.reset(),document.querySelector(".ad-form-header__preview").querySelector("img").src="img/muffin-grey.svg",e.querySelector(".ad-form__photo").innerHTML=""}}})(),window.filesModule={adPhoto(e){const t=document.querySelector(".ad-form__photo");let o=document.createElement("img");o.setAttribute("height","70"),o.setAttribute("width","70"),this.readFile(e,o)&&t.appendChild(o)},adAvatar(e){let t=document.querySelector(".ad-form-header__preview").querySelector("img");this.readFile(e,t)},readFile(e,t){let o=e.files[0],r=o.name.toLowerCase();if(window.utilModule.FILE_TYPES.some((function(e){return r.endsWith(e)}))){let e=new FileReader;return e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(o),!0}}},window.loadModule=function(e,t){let o=new XMLHttpRequest;o.responseType="json",o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.addEventListener("load",(function(){o.status===window.utilModule.StatusCode.OK?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.timeout=window.utilModule.StatusCode.TIMEOUT,o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.send()},(()=>{const e=document.querySelector(".map__pins");function t(e){window.cardModule.hide();let t=e.target.parentElement;document.removeEventListener("keydown",o),window.mapModule.pins.forEach((function(e){e.classList.remove("map__pin--active")})),t.classList.add("map__pin--active"),window.cardModule.fill(t.dataset.index),window.cardModule.mainCard.querySelector(".popup__close").addEventListener("mousedown",window.cardModule.closeClick),document.addEventListener("keydown",window.cardModule.closeEsc),window.mapModule.counter++}function o(e){if("Enter"===e.key){window.cardModule.hide();let o=e.target;o.removeEventListener("click",t),window.cardModule.fill(o.dataset.index),window.cardModule.mainCard.querySelector(".popup__close").addEventListener("mousedown",window.cardModule.closeClick),window.cardModule.mainCard.querySelector(".popup__close").addEventListener("focus",window.cardModule.closeEsc),window.mapModule.counter++}document.removeEventListener("keydown",o)}window.mapModule={pinContainer:[],pins:"",counter:0,addPinsListener(){this.pins=e.querySelectorAll("button");for(let e=1;e<this.pins.length;e++)e-=10*window.mapModule.counter,this.pins[e].addEventListener("click",t),this.pins[e].addEventListener("focus",(function(){document.addEventListener("keydown",o)}))},resetAll(){window.cardModule.hide(),window.pinModule.resetMain(),this.pins=""}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=document.querySelector(".map__pin--main"),r=document.querySelector(".map");let n=[];function d(e){let t=(document.documentElement.clientWidth-r.clientWidth)/2;e.pageX>t&&e.pageX<document.documentElement.clientWidth-t&&e.pageY<130&&e.pageY>130&&(o.setAttribute("style",`left: ${Math.ceil(e.clientX-t-o.clientWidth/2)}px; top: ${Math.ceil(e.pageY-o.clientHeight/2)}px`),window.utilModule.setAddress())}window.pinModule={listener(){document.addEventListener("mousemove",d),document.addEventListener("mouseup",(function(){document.removeEventListener("mousemove",d),window.utilModule.setAddress()}))},fillTemplate(t){n=[];for(let o=0;o<t;o++)if(window.dataModule.ads[o].offer){let t=e.cloneNode(!0);t.setAttribute("style",`left: ${window.dataModule.ads[o].location.x+window.utilModule.PIN_WIDTH/2}px; top: ${window.dataModule.ads[o].location.y+window.utilModule.PIN_WIDTH/2}px`),t.querySelector("img").src=window.dataModule.ads[o].author.avatar,t.querySelector("img").alt=window.dataModule.ads[o].offer.title,t.dataset.index=o,n.push(t)}},show(e){t.querySelectorAll(".map__pin").forEach((function(e,t){t>0&&e.parentNode.removeChild(e)}));for(let o=0;o<e;o++)t.appendChild(n[o]);t.querySelectorAll(".map__pin").forEach((function(e,t){0!==t&&e.classList.remove("map__pin--hidden")})),window.mapModule.addPinsListener()},resetMain(){o.setAttribute("style","left: 570px; top: 375px;")},hide(){t.querySelectorAll(".map__pin").forEach((function(e,t){0!==t&&e.classList.add("map__pin--hidden")}))},load(e){this.fillTemplate(e),this.show(e)},mainDown(){o.addEventListener("mousedown",this.listener)}}})(),(()=>{const e=document.querySelector(".map__filters"),t={any:{min:Number.NEGATIVE_INFINITY,max:Number.POSITIVE_INFINITY},middle:{min:1e4,max:5e4},low:{min:Number.NEGATIVE_INFINITY,max:1e4},high:{min:5e4,max:Number.POSITIVE_INFINITY}};function o(e){e.sort(((e,t)=>e.matched<t.matched?1:-1)),window.pinModule.load(function(e){let t=0;return e.forEach((function(e){t<5&&e.matched>=1&&t++})),t}(e))}function r(e){e.matched=0,Object.keys(e.matches).forEach((function(t){"features"===t?0===e.matches[t].length?e.matched+=1:e.matched+=e.matches[t].length+1:e.matched+=e.matches[t]}))}window.renderModule={change(e){switch(e.target.name){case"housing-type":window.renderModule.simpleFilter("type",e.target.value);break;case"housing-guests":window.renderModule.simpleFilter("guests",e.target.value);break;case"housing-rooms":window.renderModule.simpleFilter("rooms",e.target.value);break;case"housing-price":window.renderModule.filterPrice(e.target.value);break;case"features":window.renderModule.filterFeatures(e.target)}},simpleFilter(e,t){window.cardModule.hide(),window.dataModule.ads.forEach((function(o){"any"===t?o.matches[e]=1:(o.matches[e]=0,o.offer[e].toString()===t&&o.matches[e]++),r(o)})),o(window.dataModule.ads)},filterPrice(e){window.cardModule.hide(),window.dataModule.ads.forEach((function(o){o.matches.price=0,"any"===e&&(o.matches.price=1),o.offer.price>=t[e].min&&o.offer.price<=t[e].max&&o.matches.price++,r(o)})),o(window.dataModule.ads)},filterFeatures(e){window.cardModule.hide(),window.dataModule.ads.forEach((function(t){t.offer.features.forEach((function(o){o===e.value&&(e.checked?t.matches.features.push(o):t.matches.features.splice(t.matches.features.indexOf(o),1))})),r(t)})),o(window.dataModule.ads)},removeFilters(){e.querySelectorAll("select").forEach((function(e){e.selectedIndex=0})),e.querySelectorAll("fieldset").forEach((function(e){e.querySelectorAll("input").forEach((function(e){e.removeAttribute("checked")}))}))}}})(),(()=>{const e=document.querySelector("#success"),t=document.querySelector("#error");window.upload={popup:"",createSuccess(){let t=e.cloneNode(!0).content.querySelector(".success");document.querySelector("body").appendChild(t),document.addEventListener("keydown",(function e(o){"Escape"===o.key&&(document.querySelector("body").removeChild(t),document.removeEventListener("keydown",e))}))},createError(){function e(){document.querySelector("main").removeChild(o),o.querySelector(".error__button").removeEventListener("click",e),window.removeEventListener("click",e)}let o=t.cloneNode(!0).content.querySelector(".error");document.querySelector("main").appendChild(o),document.addEventListener("keydown",(function e(t){"Escape"===t.key&&(document.querySelector("main").removeChild(o),document.removeEventListener("keydown",e))})),o.querySelector(".error__button").addEventListener("click",e),window.addEventListener("click",e)},send(e,t,o){let r=new XMLHttpRequest;r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.responseType="json",r.send(JSON.stringify(e)),r.onreadystatechange=function(){r.readyState===XMLHttpRequest.DONE&&r.status===window.utilModule.StatusCode.OK?t():o()}}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector(".map__pin--main");window.utilModule={START_CHECKIN:12,OCLOCK:":00",PIN_WIDTH:40,PIN_LOCATION_Y_START:130,MAIN_PIN_AFTER_WIDTH:10,MAIN_PIN_AFTER_HEIGHT:22,isReset:!1,additional:!0,StatusCode:{OK:200,PAGE_NOT_FOUND:404,FORBIDDEN:500,INTERNAL_SERVER:500},FILE_TYPES:["gif","jpg","jpeg","png"],setAddress(){e.querySelector("#address").value=`${Math.trunc(t.offsetLeft)+Math.trunc(t.clientWidth/2)},${t.offsetTop+t.clientHeight+this.MAIN_PIN_AFTER_HEIGHT}`}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=document.querySelector(".map__filters"),r=document.querySelector(".map__filters"),n=document.querySelector(".map__pin--main");function d(){c(!1)}function i(e){window.pinModule.mainDown(),0===e.button&&(c(!0),document.removeEventListener("keydown",u))}function a(e){window.formModule.submit(e),c(!1)}function u(){window.pinModule.mainDown(),document.addEventListener("keydown",(function(e){"Enter"===e.key&&(c(!0),n.removeEventListener("mousedown",i))}))}function c(c){c?(e.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),n.removeEventListener("mousedown",i),n.removeEventListener("focus",u),window.dataModule.fillOffers(),window.utilModule.setAddress(),window.formModule.checkCapacity(),t.addEventListener("submit",a),t.querySelector(".ad-form__reset").addEventListener("click",d),o.addEventListener("change",window.debounceModule(window.renderModule.change)),window.cardModule.create()):(window.renderModule.removeFilters(),window.formModule.clear(),t.querySelector(".ad-form__reset").removeEventListener("click",d),n.addEventListener("mousedown",i),n.addEventListener("focus",u),window.pinModule.hide(),window.dataModule.ads=[],!0===window.utilModule.isReset&&window.mapModule.resetAll(),e.classList.add("map--faded"),t.classList.add("ad-form--disabled"),t.querySelector("#address").value=`${Math.trunc(n.offsetLeft-n.clientWidth/2)},${Math.trunc(n.offsetLeft-n.clientHeight/2)}`,n.addEventListener("mousedown",i),n.addEventListener("focus",u),window.utilModule.isReset=!0,document.removeEventListener("mousemove",window.pinModule.listener)),document.querySelector(".notice").querySelectorAll("fieldset").forEach((function(e){e.toggleAttribute("disabled")})),r.toggleAttribute("disabled"),r.classList.toggle("map__filters--disabled"),r.querySelectorAll("select").forEach((function(e){e.toggleAttribute("disabled")}))}c(!1),t.addEventListener("change",(function(e){window.formModule.checkingChanges(e)})),t.addEventListener("submit",(function(){window.formModule.checkCapacity()}))})()})();